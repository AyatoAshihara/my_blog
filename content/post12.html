---
title: （執筆中）【日次GDP】Earth Engineの衛星写真を使って景況感をナウキャスティングしてみる
author: Ayato Ashihara
date: '2019-07-08'
slug: post12
categories:
  - 日次GDP
tags:
  - R
  - 画像解析
  - Earth Engine
Draft: True
---



<pre class="r"><code>library(Rnightlights)
library(lubridate)
library(reshape2)

#(Optional performance enhancement if you have aria2c and gdal installed)
#pkgOptions(downloadMethod = &quot;aria&quot;, cropMaskMethod = &quot;gdal&quot;, extractMethod = &quot;gdal&quot;, deleteTiles = TRUE)

#Optional performance enhancement. If extractMethod=&quot;rast&quot; you can specify the number of
#CPU cores to use in parallel
#pkgOptions(extractMethod = &quot;rast&quot;, numCores=4)

ctry &lt;- &quot;USA&quot; #replace to run for any other country

#download and process monthly VIIRS stats at the highest admin level
highestAdmLevelStats &lt;- getCtryNlData(ctryCode = ctry, 
                                     admLevel = &quot;highest&quot;,
                                     nlType = &quot;VIIRS.M&quot;, 
                                     nlPeriods = nlRange(&quot;201401&quot;, &quot;201412&quot;,&quot;VIIRS.M&quot;), 
                                     nlStats = list(&quot;sum&quot;,na.rm=TRUE),
                                     ignoreMissing=FALSE)

  #Optionally plot the data
library(ggplot2)
library(plotly)

#melt the stats into key-value format for easy multi-line plotting with ggplot2
highestAdmLevelStats &lt;- melt(highestAdmLevelStats,
                              id.vars = grep(&quot;NL_&quot;, names(highestAdmLevelStats), 
                                             invert=TRUE), 
                              variable.name = &quot;nlPeriod&quot;, 
                              value.name = &quot;radiancesum&quot;)

#extract date from the NL col names
highestAdmLevelStats$nlPeriod &lt;- substr(highestAdmLevelStats$nlPeriod, 12, 17)

#format period as date
highestAdmLevelStats$nlPeriod &lt;- ymd(paste0(substr(highestAdmLevelStats$nlPeriod, 1,4), 
                                               &quot;-&quot;,substr(highestAdmLevelStats$nlPeriod, 5,6), &quot;-01&quot;))

#plot admin level sums for the year
g &lt;- ggplot(data = highestAdmLevelStats, 
            aes(x=nlPeriod, y=radiancesum, 
                color=highestAdmLevelStats[[2]])) +
  scale_x_date(date_breaks = &quot;1 month&quot;, date_labels = &quot;%Y-%m&quot;)+
  geom_line()+geom_point() + labs(color = names(highestAdmLevelStats)[2]) + 
  xlab(&quot;Month&quot;) + 
  ylab(&quot;Sum of Radiances&quot;) +
  ggtitle(paste0(unique(names(highestAdmLevelStats)[2]), &quot; sum of radiances for &quot;, ctry))

print(g)</code></pre>
<pre class="r"><code>#library(devtools)
#install_github(&quot;JesJehle/earthEngineGrabR&quot;)

library(earthEngineGrabR)

chirps_data &lt;- ee_grab(data = ee_data_collection(datasetID = &quot;UCSB-CHG/CHIRPS/DAILY&quot;,
                                                 spatialReducer = &quot;mean&quot;,
                                                 temporalReducer = &quot;sum&quot;, 
                                                 timeStart = &quot;2017-05-01&quot;,
                                                 timeEnd = &quot;2017-05-31&quot;, 
                                                 resolution = 200
                                                 ),
                       targetArea = system.file(&quot;data/territories.shp&quot;, package = &quot;earthEngineGrabR&quot;)
                      )</code></pre>
