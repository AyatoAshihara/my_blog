<!DOCTYPE html>
<html lang="en-us">
<head>  <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/xcode.min.css" rel="stylesheet">

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "https:\/\/ayatoashihara.github.io\/my_blog\/"
        },
        "articleSection" : "post",
        "name" : "【仕事関連】Asset Allocation ModelをRで組んでみた。",
        "headline" : "【仕事関連】Asset Allocation ModelをRで組んでみた。",
        "description" : "\r\n\u003cstyle type=\u0022text\/css\u0022\u003e\r\na.sourceLine { display: inline-block; line-height: 1.25; }\r\na.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }\r\na.sourceLine:empty { height: 1.2em; }\r\n.sourceCode { overflow: visible; }\r\ncode.sourceCode { white-space: pre; position: relative; }\r\ndiv.sourceCode { margin: 1em 0; }\r\npre.sourceCode { margin: 0; }\r\n@media screen {\r\ndiv.sourceCode { overflow: auto; }\r\n}\r\n@media print {\r\ncode.sourceCode { white-space: pre-wrap; }\r\na.sourceLine { text-indent: -1em; padding-left: 1em; }\r\n}\r\npre.numberSource a.sourceLine\r\n  { position: relative; left: -4em; }\r\npre.numberSource a.sourceLine::before\r\n  { content: attr(title);\r\n    position: relative; left: -1em; text-align: right; vertical-align: baseline;\r\n    border: none; pointer-events: all; display: inline-block;\r\n    -webkit-touch-callout: none; -webkit-user-select: none;\r\n    -khtml-user-select: none; -moz-user-select: none;\r\n    -ms-user-select: none; user-select: none;\r\n    padding: 0 4px; width: 4em;\r\n    color: #aaaaaa;\r\n  }\r\npre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }\r\ndiv.sourceCode\r\n  { background-color: #f8f8f8; }\r\n@media screen {\r\na.sourceLine::before { text-decoration: underline; }\r\n}\r\ncode span.al { color: #ef2929; } \/* Alert *\/\r\ncode span.an { color: #8f5902; font-weight: bold; font-style: italic; } \/* Annotation *\/\r\ncode span.at { color: #c4a000; } \/* Attribute *\/\r\ncode span.bn { color: #0000cf; } \/* BaseN *\/\r\ncode span.cf { color: #204a87; font-weight: bold; } \/* ControlFlow *\/\r\ncode span.ch { color: #4e9a06; } \/* Char *\/\r\ncode span.cn { color: #000000; } \/* Constant *\/\r\ncode span.co { color: #8f5902; font-style: italic; } \/* Comment *\/\r\ncode span.cv { color: #8f5902; font-weight: bold; font-style: italic; } \/* CommentVar *\/\r\ncode span.do { color: #8f5902; font-weight: bold; font-style: italic; } \/* Documentation *\/\r\ncode span.dt { color: #204a87; } \/* DataType *\/\r\ncode span.dv { color: #0000cf; } \/* DecVal *\/\r\ncode span.er { color: #a40000; font-weight: bold; } \/* Error *\/\r\ncode span.ex { } \/* Extension *\/\r\ncode span.fl { color: #0000cf; } \/* Float *\/\r\ncode span.fu { color: #000000; } \/* Function *\/\r\ncode span.im { } \/* Import *\/\r\ncode span.in { color: #8f5902; font-weight: bold; font-style: italic; } \/* Information *\/\r\ncode span.kw { color: #204a87; font-weight: bold; } \/* Keyword *\/\r\ncode span.op { color: #ce5c00; font-weight: bold; } \/* Operator *\/\r\ncode span.ot { color: #8f5902; } \/* Other *\/\r\ncode span.pp { color: #8f5902; font-style: italic; } \/* Preprocessor *\/\r\ncode span.sc { color: #000000; } \/* SpecialChar *\/\r\ncode span.ss { color: #4e9a06; } \/* SpecialString *\/\r\ncode span.st { color: #4e9a06; } \/* String *\/\r\ncode span.va { color: #000000; } \/* Variable *\/\r\ncode span.vs { color: #4e9a06; } \/* VerbatimString *\/\r\ncode span.wa { color: #8f5902; font-weight: bold; font-style: italic; } \/* Warning *\/\r\n\u003c\/style\u003e\r\n\r\n\r\n\u003cp\u003e今回はいつもと違って金融関連の記事を書きました。というのも社内でワークショップがあり、アセットアロケーションモデルを構築する必要が生じたからです。休日は国会図書館に籠り、先行研究を漁った結果、分散共分散行列をGARCHやARMAで推定し、最小分散ポートフォリオの性能向上を目指している論文がいくつか存在することがわかりました。今回はこれをRで実践し、推定方法によってパフォーマンスがどれほど変化するのかを実証してみたいと思います。\u003c\/p\u003e\r\n",
        "inLanguage" : "en",
        "author" : "AyatoAshihara",
        "creator" : "AyatoAshihara",
        "publisher": "AyatoAshihara",
        "accountablePerson" : "AyatoAshihara",
        "copyrightHolder" : "AyatoAshihara",
        "copyrightYear" : "2019",
        "datePublished": "2019-02-17 00:00:00 \u002b0000 UTC",
        "dateModified" : "2019-02-17 00:00:00 \u002b0000 UTC",
        "url" : "https:\/\/ayatoashihara.github.io\/my_blog\/post\/post2\/",
        "wordCount" : "934",
        "image" : "https://ayatoashihara.github.io/my_blog/img/portfolio/post2.png"",
        "keywords" : [ "Blog" ]   
    }
    </script>


 <title>【仕事関連】Asset Allocation ModelをRで組んでみた。 </title>


<meta name="description" content="マクロ経済、機械学習系の記事を投稿しています。" />



<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<link rel="stylesheet" id="ct-tracks-google-fonts-css" href="//fonts.googleapis.com/css?family=Raleway%3A400%2C700&amp;subset=latin%2Clatin-ext&amp;ver=4.7.2" type="text/css" media="all">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">

<link href="https://ayatoashihara.github.io/my_blog/css/style.css?v=1603208085" rel="stylesheet" id="theme-stylesheet" type='text/css' media='all'>

<link href="https://ayatoashihara.github.io/my_blog/css/custom.css?v=1603208085" rel="stylesheet" type='text/css' media='all'>
<link rel="shortcut icon" href="https://ayatoashihara.github.io/my_blog/img/favicon.ico" type="image/x-icon">
<link rel="icon" href="https://ayatoashihara.github.io/my_blog/img/favicon.ico" type="image/x-icon">


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-140804055-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>


<body class="post-template-default single single-post single-format-standard ct-body singular singular-post not-front standard">

  <div id="overflow-container" class="overflow-container">
    <a class="skip-content" href="#main">Skip to content</a>
    <header id="site-header" class="site-header" role="banner">
      <div class='top-navigation'>
        <div class='container'>

  <div id="menu-secondary" class="menu-container menu-secondary" role="navigation">
    <button id="toggle-secondary-navigation" class="toggle-secondary-navigation"><i class="fas fa-plus"></i></button>

    <div class="menu">

      <ul id="menu-secondary-items" class="menu-secondary-items">
        
        <li id="menu-item" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item">
          <a href="/my_blog/categories/%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0">プログラミング</a>
        </li>
        
        <li id="menu-item" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item">
          <a href="/my_blog/categories/%E3%83%9E%E3%82%AF%E3%83%AD%E7%B5%8C%E6%B8%88%E5%AD%A6">マクロ経済学</a>
        </li>
        
        <li id="menu-item" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item">
          <a href="/my_blog/categories/%E4%BB%95%E4%BA%8B%E9%96%A2%E9%80%A3">仕事関連</a>
        </li>
        
        <li id="menu-item" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item">
          <a href="/my_blog/categories/%E5%8D%98%E7%99%BA">単発</a>
        </li>
        
        <li id="menu-item" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item">
          <a href="/my_blog/categories/%E6%97%A5%E6%AC%A1gdp">日次gdp</a>
        </li>
        
        <li id="menu-item" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item">
          <a href="/my_blog/categories/%E7%AB%B6%E9%A6%AC">競馬</a>
        </li>
        
        <li id="menu-item" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item">
          <a href="/my_blog/categories/%E7%B5%B1%E8%A8%88">統計</a>
        </li>
        

      </ul>

    </div>

  </div>


  <ul class="social-media-icons">


    
    <li>
      <a href="https://www.facebook.com/ASSIY" data-animate-hover="pulse" class="facebook" target="_blank">
        <i class="fab fa-facebook-square" title="facebook"></i>
        <span class="screen-reader-text">facebook</span>
      </a>
    </li>
    

    

    

    

    
    <li>
      <a href="mailto:assiy119@yahoo.co.jp" data-animate-hover="pulse" class="email">
        <i class="fas fa-envelope" title="email"></i>
        <span class="screen-reader-text">email</span>
      </a>
    </li>
    

    
    <li>
      <a href="https://www.linkedin.com/in/%E5%BD%A9%E4%BA%BA-%E8%91%A6%E5%8E%9F-9391b7143/" data-animate-hover="pulse" class="linkedin" target="_blank">
        <i class="fab fa-linkedin-in" title="linkedin"></i>
        <span class="screen-reader-text">linkedin</span>
      </a>
    </li>
    

    


    
    <li>
      <a href="https://github.com/AyatoAshihara/my_blog" data-animate-hover="pulse" class="github" target="_blank">
        <i class="fab fa-github" title="github"></i>
        <span class="screen-reader-text">github</span>
      </a>
    </li>
    


    

    
    <li>
      <a href="https://ayatoashihara.github.io/my_blog/index.xml" data-animate-hover="pulse" class="rss" target="_blank">
        <i class="fas fa-rss" title="rss"></i>
        <span class="screen-reader-text">rss</span>
      </a>
    </li>
    


  </ul></div>

      </div>

      <div class="container">
        


<div id="title-info" class="title-info">
  <div id='site-title' class='site-title'>
    
    <a href="/my_blog"> 東京の資産運用会社で働く社会人が研究に没頭するブログ </a>
    </div>
  </div>
  <button id="toggle-navigation" class="toggle-navigation">
    <i class="fas fa-bars"></i>
  </button>

  <div id="menu-primary-tracks" class="menu-primary-tracks"></div>
  <div id="menu-primary" class="menu-container menu-primary" role="navigation">
    
    <p class="site-description">院卒3年目の社会人が夜な夜な更新中。本ブログの内容は筆者が所属する組織の公式見解とは全く関係ありません。</p>
    

    <div class="menu">
      <ul id="menu-primary-items" class="menu-primary-items">
        
        
        <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page '>
          <a href="https://ayatoashihara.github.io/my_blog/">Home</a>
          
        </li>
        
        <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page '>
          <a href="https://ayatoashihara.github.io/my_blog/about/">About</a>
          
        </li>
        
        <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page '>
          <a href="https://ayatoashihara.github.io/my_blog/contact/">Get in touch</a>
          
        </li>
        
      </ul>
    </div>

  </div>

      </div>
    </header>

    <div id="main" class="main" role="main">

      
  
  
    
  
  
  <div id="loop-container" class="loop-container">
    
    <div class="post type-post status-publish format-standard has-post-thumbnail hentry category-design tag-design tag-standard-2 tag-tagalicious tag-travel entry full-without-featured odd excerpt-1">

      <div class='featured-image lazy lazy-bg-image'  data-background="https://ayatoashihara.github.io/my_blog/img/portfolio/post2.png">
      </div>
      
        <div class="entry-meta">
          <span class="date">17 February</span>	<span> / </span>

          <span class="author">
            <a href="https://ayatoashihara.github.io/my_blog/" title="Posts by " rel="author"></a>
          </span>


          
          <span class="category">
            <span> / </span>

            <a href="/categories/%E4%BB%95%E4%BA%8B%E9%96%A2%E9%80%A3">仕事関連</a>
          </span>
          


        </div>
        <div class='entry-header'>
          <h1 class='entry-title'> 【仕事関連】Asset Allocation ModelをRで組んでみた。</h1>
        </div>
        <div class="entry-container">
          <div class="entry-content">
            <article>
              <p>おはこんばんにちは。勤め先で、アセットアロケーションに関するワークショップに参加したので、この分野は完全なる専門外ですがシミュレーションをしてみたいと思います。今回は、最小分散ポートフォリオ(minimum variance portfolio)を基本ポートフォリオとしたうえで、その分散共分散行列（予測値）をどのように推計するのかという点について先行研究を参考にエクササイズしていきたいと思います。先行研究は以下の論文です（オペレーションリサーチのジャーナルでした）。</p>
<p>[<a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2947643:embed:cite" class="uri">https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2947643:embed:cite</a>]</p>
<div id="section" class="section level3">
<h3>最小分散ポートフォリオ</h3>
<p>最小分散ポートフォリオの詳しい説明はここでは割愛しますが、要は各資産（内株、外株、内債、外債、オルタナ）のリターンの平均と分散を計算し、それらを縦軸平均値、横軸分散の二次平面にプロットしたうえで、投資可能範囲を計算し、その集合の中で最も分散が小さくなるポートフォリオの事らしいです（下図参照）。</p>
<div class="figure">
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2d/Minimum_variance_flontier_of_MPT.svg/1280px-Minimum_variance_flontier_of_MPT.svg.png" alt="minimum variance portfolio" />
<p class="caption">minimum variance portfolio</p>
</div>
<p>先行研究のCarroll et. al. (2017)では、「 this paper focusses on minimum-variance portfolios requiring only estimates of asset covariance, hence bypassing the well-known problem of estimation error in forecasting expected asset returns. 」と記載されており、現状でも期待リターンの推計は難しく、それを必要としない最小分散ポートフォリオは有益で実践的な手法であるといえます。最小分散ポートフォリオの目的関数は、その名の通り「分散を最小化すること」です。今、各資産のリターンを集めたベクトルを[tex:r]、各資産の保有ウェイトを<span class="math inline">\(\theta\)</span>、ポートフォリオリターンを<span class="math inline">\(R_{p}\)</span>で表すことにすると、ポートフォリオ全体の分散<span class="math inline">\(var(R_{p})\)</span>は以下のように記述できます。</p>
<p><span class="math display">\[
var(R_{p}) = var(r^{T}\theta) = E( (r^{T}\theta)(r^{T}\theta)^{T}) = \theta^{T}\Sigma\theta
\]</span></p>
<p>ここで<span class="math inline">\(Sigma\)</span>は<span class="math inline">\(r\)</span>の分散共分散行列です。よって、最小化問題は以下になります。</p>
<p><span class="math display">\[
\min_{\theta}(\theta^{T}\Sigma\theta) \\
s.t 1^{T}\theta = 1
\]</span></p>
<p>ここでは、フルインベストメントを制約条件に加えています。ラグランジュ未定乗数法を用いてこの問題を解いてみましょう。ラグランジュ関数<span class="math inline">\(L\)</span>は以下のようになります。</p>
<p><span class="math display">\[
L = \theta^{T}\Sigma\theta + \lambda(1^{T}\theta - 1)
\]</span></p>
<p>1階の条件は、</p>
<p><span class="math display">\[
\displaystyle\frac{\partial L}{\partial \theta} = 2\Sigma\theta + 1\lambda = 0 \\
\displaystyle \frac{\partial L}{\partial \lambda} = 1^{T} \theta = 1
\]</span></p>
<p>1本目の式を<span class="math inline">\(\theta\)</span>について解くと、</p>
<p><span class="math display">\[
\theta = \Sigma^{-1}1\lambda^{*}
\]</span></p>
<p>となります。ここで、<span class="math inline">\(\lambda^{*}=-1/2\lambda\)</span>です。これを2本目の式に代入し、<span class="math inline">\(\lambda^{*}\)</span>について解きます。</p>
<p><span class="math display">\[
1^{T}\Sigma1\lambda^{*} = 1 \\
\displaystyle \lambda^{*} = \frac{1}{1^{T}\Sigma^{-1}1}
\]</span></p>
<p><span class="math inline">\(\theta = \Sigma^{-1}1\lambda^{*}\)</span>だったので、<span class="math inline">\(\lambda^{*}\)</span>を消去すると、</p>
<p><span class="math display">\[
\displaystyle \theta_{gmv} = \frac{\Sigma^{-1}1}{1^{T}\Sigma^{-1}1}
\]</span></p>
<p>となり、最適なウェイトを求めることができました。とりあえず、これをRで実装しておきます。</p>
<pre class="sourceCode r"><code class="sourceCode r">gmv &lt;-<span class="st"> </span><span class="cf">function</span>(r_dat,r_cov){
  <span class="kw">library</span>(MASS)
  i &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span>,<span class="kw">NCOL</span>(r_dat),<span class="dv">1</span>)
  r_weight &lt;-<span class="st"> </span>(<span class="kw">ginv</span>(r_cov)<span class="op">%*%</span>i)<span class="op">/</span><span class="kw">as.numeric</span>(<span class="kw">t</span>(i)<span class="op">%*%</span><span class="kw">ginv</span>(r_cov)<span class="op">%*%</span>i)
  wr_dat &lt;-<span class="st"> </span>r_dat<span class="op">*</span><span class="kw">as.numeric</span>(r_weight)
  portfolio &lt;-<span class="st"> </span><span class="kw">apply</span>(wr_dat,<span class="dv">1</span>,sum)
  pr_dat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(wr_dat,portfolio)
  sd &lt;-<span class="st"> </span><span class="kw">sd</span>(portfolio)
  result &lt;-<span class="st"> </span><span class="kw">list</span>(r_weight,pr_dat,sd)
  <span class="kw">names</span>(result) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;weight&quot;</span>,<span class="st">&quot;return&quot;</span>,<span class="st">&quot;portfolio risk&quot;</span>) 
  <span class="kw">return</span>(result)
}

nlgmv &lt;-<span class="st"> </span><span class="cf">function</span>(r_dat,r_cov){
  qp.out &lt;-<span class="st"> </span><span class="kw">solve.QP</span>(<span class="dt">Dmat=</span>r_cov,<span class="dt">dvec=</span><span class="kw">rep</span>(<span class="dv">0</span>,<span class="kw">NCOL</span>(r_dat)),<span class="dt">Amat=</span><span class="kw">cbind</span>(<span class="kw">rep</span>(<span class="dv">1</span>,<span class="kw">NCOL</span>(r_dat)),<span class="kw">diag</span>(<span class="kw">NCOL</span>(r_dat))),
           <span class="dt">bvec=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="kw">rep</span>(<span class="dv">0</span>,<span class="kw">NCOL</span>(r_dat))),<span class="dt">meq=</span><span class="dv">1</span>)
  r_weight &lt;-<span class="st"> </span>qp.out<span class="op">$</span>solution
  wr_dat &lt;-<span class="st"> </span>r_dat<span class="op">*</span>r_weight
  portfolio &lt;-<span class="st"> </span><span class="kw">apply</span>(wr_dat,<span class="dv">1</span>,sum)
  pr_dat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(wr_dat,portfolio)
  sd &lt;-<span class="st"> </span><span class="kw">sd</span>(portfolio)
  result &lt;-<span class="st"> </span><span class="kw">list</span>(r_weight,pr_dat,sd)
  <span class="kw">names</span>(result) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;weight&quot;</span>,<span class="st">&quot;return&quot;</span>,<span class="st">&quot;portfolio risk&quot;</span>)
  <span class="kw">return</span>(result)
}</code></pre>
<p>入力は各資産のリターンと分散共分散行列になっています。出力はウェイト、リターン、リスクです。nlgmvは最小分散ポートフォリオの空売り制約バージョンです。解析的な解は得られないので、数値的に買いを求めています。</p>
</div>
<div id="section-1" class="section level3">
<h3>分散共分散行列をどのように求めるか</h3>
<p>最小分散ポートフォリオの計算式は求めることができました。次は、その入力である分散共分散行列をどうやって求めるのかについて分析したいと思います。一番原始的な方法はその時点以前に利用可能なリターンデータを標本として分散共分散行列を求め、その値を固定して最小分散ポートフォリオを求めるというヒストリカルなアプローチかと思います（つまりウェイトも固定）。ただ、これはあくまで過去の平均値を将来の予想値に使用するため、いろいろ問題が出てくるかと思います。専門外の私が思いつくものとしては、前日ある資産Aのリターンが大きく下落したという場面で明日もこの資産の分散は大きくなることが予想されるにも関わらず、平均値を使用するため昨日の効果が薄められてしまうことでしょうか。それに、ウェイトを最初から変更しないというのも時間がたつにつれ、最適点から離れていく気がします。ただ、ではどう推計するのかついてはこの分野でも試行錯誤が行われているようです。Carroll et. al. (2017)でも「The estimation of covariance matrices for portfolios with a large number of assets still remains a fundamental challenge in portfolio optimization.」と述べられていました。この論文では以下のようなモデルを用いて推計が行われています。いずれも、分散共分散行列を時変としているところに特徴があります。</p>
<ol style="list-style-type: decimal">
<li>Constant conditional correlation (CCC) model</li>
</ol>
<p>元論文はこちら。</p>
<p>[<a href="https://www.jstor.org/stable/2109358?read-now=1&amp;seq=3#page_scan_tab_contents:title" class="uri">https://www.jstor.org/stable/2109358?read-now=1&amp;seq=3#page_scan_tab_contents:title</a>]</p>
<p>まず、分散共分散行列と相関行列の関係性から、<span class="math inline">\(\Sigma_{t} = D_{t}R_{t}D_{t}\)</span>となります。ここで、<span class="math inline">\(R_{t}\)</span>は相関行列、<span class="math inline">\(D_{t}\)</span>は<span class="math inline">\(diag(\sigma_{1,t},...,\sigma_{N,t})\)</span>で各資産<span class="math inline">\(tt\)</span>期の標準偏差<span class="math inline">\(\sigma_{i,t}\)</span>を対角成分に並べた行列です。ここから、<span class="math inline">\(D_{t}\)</span>と<span class="math inline">\(R_{t}\)</span>を分けて推計していきます。まず、<span class="math inline">\(D_{t}\)</span>ですが、こちらは以下のような多変量GARCHモデル(1,1)で推計します。</p>
<p><span class="math display">\[
r_{t} = \mu + u_{t} \\
u_{t} = \sigma_{t}\epsilon \\
\sigma_{t}^{2} = \alpha_{0} + \alpha_{1}u_{t-1}^{2} + \alpha_{2}\sigma_{t-1}^{2} \\
\epsilon_{t} = NID(0,1) \\
E(u_{t}|u_{t-1}) = 0
\]</span></p>
<p>ここで、<span class="math inline">\(\mu\)</span>はリターンの標本平均です。<span class="math inline">\(\alpha_{i}\)</span>は推定すべきパラメータ。<span class="math inline">\(D_{t}\)</span>をGARCHで推計しているので、リターンの分布が正規分布より裾野の厚い分布に従い、またリターンの変化は一定ではなく前日の分散に依存する関係をモデル化しているといえるのではないでしょうか。とりあえずこれで<span class="math inline">\(D_{t}\)</span>の推計はできたということにします。次に<span class="math inline">\(R_{t}\)</span>の推計ですが、このモデルではリターンを標本として求めるヒストリカルなアプローチを取ります。つまり、<span class="math inline">\(R_{t}\)</span>は定数です。よって、リターン変動の大きさは時間によって変化するが、各資産の相対的な関係性は不変であるという仮定を置いていることになります。</p>
<ol start="2" style="list-style-type: decimal">
<li>Dynamic Conditional Correlation (DCC) model
元論文はこちら。</li>
</ol>
<p>[<a href="http://www.cass.city.ac.uk/__data/assets/pdf_file/0003/78960/Week7Engle_2002.pdf" class="uri">http://www.cass.city.ac.uk/__data/assets/pdf_file/0003/78960/Week7Engle_2002.pdf</a>]</p>
<p>こちらのモデルでは、<span class="math inline">\(D_{t}\)</span>を求めるところまでは①と同じですが、[<span class="math inline">\(R_{t}\)</span>の求め方が異なっており、ARMA(1,1)を用いて推計します。相関行列はやはり定数ではないということで、<span class="math inline">\(tex:t\)</span>期までに利用可能なリターンを用いて推計をかけようということになっています。このモデルの相関行列<span class="math inline">\(R_{t}\)</span>は、</p>
<p><span class="math display">\[
R_{t} = diag(Q_{t})^{-1/2}Q_{t}diag(Q_{t})^{-1/2}
\]</span></p>
<p>です。ここで、<span class="math inline">\(Q_{t}\)</span>は<span class="math inline">\(t\)</span>期での条件付分散共分散行列で以下のように定式化されます。</p>
<p><span class="math display">\[
Q_{t} = \bar{Q}(1-a-b) + adiag(Q_{t-1})^{1/2}\epsilon_{i,t-1}\epsilon_{i,t-1}diag(Q_{t-1})^{1/2} + bQ_{t-1}
\]</span></p>
<p>ここで、<span class="math inline">\(\bar{Q}\)</span>はヒストリカルな方法で計算した分散共分散行列であり、<span class="math inline">\(a,b\)</span>はパラメータです。この方法では、先ほどとは異なり、リターン変動の大きさが時間によって変化するだけでなく、各資産の相対的な関係性も通時的に変化していくという仮定を置いていることになります。金融危機時には全資産のリターンが下落し、各資産の相関が正になる事象も観測されていることから、この定式化は魅力的であるということができるのではないでしょうか。</p>
<ol start="3" style="list-style-type: decimal">
<li>Dynamic Equicorrelation (DECO) model
元論文はこちら</li>
</ol>
<p>[<a href="https://faculty.chicagobooth.edu/bryan.kelly/research/pdf/deco.pdf" class="uri">https://faculty.chicagobooth.edu/bryan.kelly/research/pdf/deco.pdf</a>]</p>
<p>この論文はまだきっちり読めていないのですが、相関行列[tex:R_{t}]の定義から</p>
<p><span class="math display">\[
R_{t} = (1-\rho_{t})I_{N} + \rho_{t}1
\]</span></p>
<p>となるようです。ここで、<span class="math inline">\(\rho_{t}\)</span>はスカラーでequicorrelationの程度を表す係数です。equicorrelationとは平均的なペアワイズ相関の事であると理解しています。つまりは欠損値がなければ普通の相関と変わりないんじゃないかと。ただ、資産が増えればそのような問題にも対処する必要があるのでその点ではよい推定量のようです。<span class="math inline">\(\rho_{t}\)</span>は以下のように求めることができます。</p>
<p><span class="math display">\[
\displaystyle \rho_{t} = \frac{1}{N(N-1)}(\iota^{T}R_{t}^{DCC}\iota - N) = \frac{2}{N(N-1)}\sum_{i&gt;j}\frac{q_{ij,t}}{\sqrt{q_{ii,t} q_{jj,t}}}
\]</span></p>
<p>ここで、<span class="math inline">\(\iota\)</span>はN×1ベクトルで要素は全て1です。また、<span class="math inline">\(q_{ij,t}\)</span>は<span class="math inline">\(Q_{t}\)</span>のi,j要素です。</p>
<p>さて、分散共分散行列のモデル化ができたところで、ここまでをRで実装しておきます。</p>
<pre class="sourceCode r"><code class="sourceCode r">carroll &lt;-<span class="st"> </span><span class="cf">function</span>(r_dat,FLG){
  
  <span class="kw">library</span>(rmgarch)
  
  <span class="cf">if</span>(FLG <span class="op">==</span><span class="st"> &quot;benchmark&quot;</span>){
    H &lt;-<span class="st"> </span><span class="kw">cov</span>(r_dat)
  }<span class="cf">else</span>{
    <span class="co">#1. define variables</span>
    N &lt;-<span class="st"> </span><span class="kw">NCOL</span>(r_dat) <span class="co"># the number of assets</span>
    
    <span class="co">#2. estimate covariance matrix</span>
    basic_garch =<span class="st"> </span><span class="kw">ugarchspec</span>(<span class="dt">mean.model =</span> <span class="kw">list</span>(<span class="dt">armaOrder =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>),<span class="dt">include.mean=</span><span class="ot">TRUE</span>), <span class="dt">variance.model =</span> <span class="kw">list</span>(<span class="dt">garchOrder =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="dt">model =</span> <span class="st">&#39;sGARCH&#39;</span>), <span class="dt">distribution.model =</span> <span class="st">&#39;norm&#39;</span>)
    multi_garch =<span class="st"> </span><span class="kw">multispec</span>(<span class="kw">replicate</span>(N, basic_garch))
    dcc_set =<span class="st"> </span><span class="kw">dccspec</span>(<span class="dt">uspec =</span> multi_garch, <span class="dt">dccOrder =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="dt">distribution =</span> <span class="st">&quot;mvnorm&quot;</span>,<span class="dt">model =</span> <span class="st">&quot;DCC&quot;</span>)
    fit_dcc_garch =<span class="st"> </span><span class="kw">dccfit</span>(dcc_set, <span class="dt">data =</span> r_dat, <span class="dt">fit.control =</span> <span class="kw">list</span>(<span class="dt">eval.se =</span> <span class="ot">TRUE</span>))
    forecast_dcc_garch &lt;-<span class="st"> </span><span class="kw">dccforecast</span>(fit_dcc_garch)
    <span class="cf">if</span> (FLG <span class="op">==</span><span class="st"> &quot;CCC&quot;</span>){
      <span class="co">#Constant conditional correlation (CCC) model</span>
      D &lt;-<span class="st"> </span><span class="kw">sigma</span>(forecast_dcc_garch)
      R_ccc &lt;-<span class="st"> </span><span class="kw">cor</span>(r_dat)
      H &lt;-<span class="st"> </span><span class="kw">diag</span>(D[,,<span class="dv">1</span>])<span class="op">%*%</span>R_ccc<span class="op">%*%</span><span class="kw">diag</span>(D[,,<span class="dv">1</span>])
      <span class="kw">colnames</span>(H) &lt;-<span class="st"> </span><span class="kw">colnames</span>(r_dat)
      <span class="kw">rownames</span>(H) &lt;-<span class="st"> </span><span class="kw">colnames</span>(r_dat)
    }
    <span class="cf">else</span>{
      <span class="co">#Dynamic Conditional Correlation (DCC) model</span>
      H &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">rcov</span>(forecast_dcc_garch)[[<span class="dv">1</span>]][,,<span class="dv">1</span>])
      <span class="cf">if</span> (FLG <span class="op">==</span><span class="st"> &quot;DECO&quot;</span>){
        <span class="co">#Dynamic Equicorrelation (DECO) model</span>
        one &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span>,N,N)
        iota &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>,N)
        Q_dcc &lt;-<span class="st"> </span><span class="kw">rcor</span>(forecast_dcc_garch,<span class="dt">type=</span><span class="st">&quot;Q&quot;</span>)[[<span class="dv">1</span>]][,,<span class="dv">1</span>]
        rho &lt;-<span class="st"> </span><span class="kw">as.vector</span>((N<span class="op">*</span>(N<span class="dv">-1</span>))<span class="op">^</span>(<span class="op">-</span><span class="dv">1</span>)<span class="op">*</span>(<span class="kw">t</span>(iota)<span class="op">%*%</span>Q_dcc<span class="op">%*%</span>iota<span class="op">-</span>N))
        D &lt;-<span class="st"> </span><span class="kw">sigma</span>(forecast_dcc_garch)
        R_deco &lt;-<span class="st"> </span>(<span class="dv">1</span><span class="op">-</span>rho)<span class="op">*</span><span class="kw">diag</span>(<span class="dv">1</span>,N,N) <span class="op">+</span><span class="st"> </span>rho<span class="op">*</span>one
        H &lt;-<span class="st"> </span><span class="kw">diag</span>(D[,,<span class="dv">1</span>])<span class="op">%*%</span>R_deco<span class="op">%*%</span><span class="kw">diag</span>(D[,,<span class="dv">1</span>])
        <span class="kw">colnames</span>(H) &lt;-<span class="st"> </span><span class="kw">colnames</span>(r_dat)
        <span class="kw">rownames</span>(H) &lt;-<span class="st"> </span><span class="kw">colnames</span>(r_dat)
      }
    }
  }
  <span class="kw">return</span>(H)
}</code></pre>
<p>本来であれば、パッケージを使用するべきではないのですが、今日はエクササイズなので推計結果だけを追い求めたいと思います。GARCHについては再来週ぐらいに記事を書く予定です。
これで準備ができました。この関数にリターンデータを入れて、分散共分散行列を計算し、それを用いて最小分散ポートフォリオを計算することができるようになりました。</p>
</div>
<div id="section-2" class="section level3">
<h3>テスト用データの収集</h3>
<p>データは以下の記事を参考にしました。</p>
<p>[<a href="https://www.r-bloggers.com/introduction-to-asset-allocation/:embed:cite" class="uri">https://www.r-bloggers.com/introduction-to-asset-allocation/:embed:cite</a>]</p>
<p>使用したのは、以下のインデックスに連動するETF(iShares)の基準価額データです。</p>
<p>①S&amp;P500
②NASDAQ100
③MSCI Emerging Markets
④Russell 2000
⑤MSCI EAFE
⑥US 20 Year Treasury(the Barclays Capital 20+ Year Treasury Index)
⑦U.S. Real Estate(the Dow Jones US Real Estate Index)
⑧gold bullion market</p>
<p>まず、データ集めです。</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(quantmod)

<span class="co">#**************************</span>
<span class="co"># ★8 ASSETS SIMULATION</span>
<span class="co"># SPY - S&amp;P 500 </span>
<span class="co"># QQQ - Nasdaq 100</span>
<span class="co"># EEM - Emerging Markets</span>
<span class="co"># IWM - Russell 2000</span>
<span class="co"># EFA - EAFE</span>
<span class="co"># TLT - 20 Year Treasury</span>
<span class="co"># IYR - U.S. Real Estate</span>
<span class="co"># GLD - Gold</span>
<span class="co">#**************************</span>

<span class="co"># load historical prices from Yahoo Finance</span>
symbol.names =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;S&amp;P 500&quot;</span>,<span class="st">&quot;Nasdaq 100&quot;</span>,<span class="st">&quot;Emerging Markets&quot;</span>,<span class="st">&quot;Russell 2000&quot;</span>,<span class="st">&quot;EAFE&quot;</span>,<span class="st">&quot;20 Year Treasury&quot;</span>,<span class="st">&quot;U.S. Real Estate&quot;</span>,<span class="st">&quot;Gold&quot;</span>)
symbols =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SPY&quot;</span>,<span class="st">&quot;QQQ&quot;</span>,<span class="st">&quot;EEM&quot;</span>,<span class="st">&quot;IWM&quot;</span>,<span class="st">&quot;EFA&quot;</span>,<span class="st">&quot;TLT&quot;</span>,<span class="st">&quot;IYR&quot;</span>,<span class="st">&quot;GLD&quot;</span>)
<span class="kw">getSymbols</span>(symbols, <span class="dt">from =</span> <span class="st">&#39;1980-01-01&#39;</span>, <span class="dt">auto.assign =</span> <span class="ot">TRUE</span>)

<span class="co">#gn dates for all symbols &amp; convert to monthly</span>
hist.prices =<span class="st"> </span><span class="kw">merge</span>(SPY,QQQ,EEM,IWM,EFA,TLT,IYR,GLD)
month.ends =<span class="st"> </span><span class="kw">endpoints</span>(hist.prices, <span class="st">&#39;day&#39;</span>)
hist.prices =<span class="st"> </span><span class="kw">Cl</span>(hist.prices)[month.ends, ]
<span class="kw">colnames</span>(hist.prices) =<span class="st"> </span>symbols

<span class="co"># remove any missing data</span>
hist.prices =<span class="st"> </span><span class="kw">na.omit</span>(hist.prices[<span class="st">&#39;1995::&#39;</span>])

<span class="co"># compute simple returns</span>
hist.returns =<span class="st"> </span><span class="kw">na.omit</span>( <span class="kw">ROC</span>(hist.prices, <span class="dt">type =</span> <span class="st">&#39;discrete&#39;</span>) )

<span class="co"># compute historical returns, risk, and correlation</span>
ia =<span class="st"> </span><span class="kw">list</span>()
ia<span class="op">$</span>expected.return =<span class="st"> </span><span class="kw">apply</span>(hist.returns, <span class="dv">2</span>, mean, <span class="dt">na.rm =</span> T)
ia<span class="op">$</span>risk =<span class="st"> </span><span class="kw">apply</span>(hist.returns, <span class="dv">2</span>, sd, <span class="dt">na.rm =</span> T)
ia<span class="op">$</span>correlation =<span class="st"> </span><span class="kw">cor</span>(hist.returns, <span class="dt">use =</span> <span class="st">&#39;complete.obs&#39;</span>, <span class="dt">method =</span> <span class="st">&#39;pearson&#39;</span>)

ia<span class="op">$</span>symbols =<span class="st"> </span>symbols
ia<span class="op">$</span>symbol.names =<span class="st"> </span>symbol.names
ia<span class="op">$</span>n =<span class="st"> </span><span class="kw">length</span>(symbols)
ia<span class="op">$</span>hist.returns =<span class="st"> </span>hist.returns

<span class="co"># convert to annual, year = 12 months</span>
annual.factor =<span class="st"> </span><span class="dv">12</span>
ia<span class="op">$</span>expected.return =<span class="st"> </span>annual.factor <span class="op">*</span><span class="st"> </span>ia<span class="op">$</span>expected.return
ia<span class="op">$</span>risk =<span class="st"> </span><span class="kw">sqrt</span>(annual.factor) <span class="op">*</span><span class="st"> </span>ia<span class="op">$</span>risk

<span class="kw">rm</span>(SPY,QQQ,EEM,IWM,EFA,TLT,IYR,GLD)</code></pre>
<p>リターンをプロットするとこんな感じです。</p>
<pre class="sourceCode r"><code class="sourceCode r">PerformanceAnalytics<span class="op">::</span><span class="kw">charts.PerformanceSummary</span>(hist.returns, <span class="dt">main =</span> <span class="st">&quot;パフォーマンスサマリー&quot;</span>)</code></pre>
<p><img src="/my_blog/post/post2_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>次に、バックテストのコーディングを行います。一気にコードを公開します。</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># BACK </span><span class="al">TEST</span>
backtest &lt;-<span class="st"> </span><span class="cf">function</span>(r_dat,FLG,start_date,span,learning_term,port){
  <span class="co">#-----------------------------------------</span>
  <span class="co"># BACKTEST</span>
  <span class="co"># r_dat - return data(xts object) </span>
  <span class="co"># FLG - flag(CCC,DCC,DECO)</span>
  <span class="co"># start_date - start date for backtest</span>
  <span class="co"># span - rebalance frequency</span>
  <span class="co"># learning_term - learning term (days)</span>
  <span class="co"># port - method of portfolio optimization</span>
  <span class="co">#-----------------------------------------</span>
  
  <span class="kw">library</span>(stringi)

  initial_dat &lt;-<span class="st"> </span>r_dat[<span class="kw">stri_c</span>(<span class="kw">as.Date</span>(start_date)<span class="op">-</span>learning_term,<span class="st">&quot;::&quot;</span>,<span class="kw">as.Date</span>(start_date))]
  <span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">NROW</span>(initial_dat)<span class="op">:</span><span class="kw">NROW</span>(r_dat)) {
    <span class="cf">if</span> (i <span class="op">==</span><span class="st"> </span><span class="kw">NROW</span>(initial_dat)){
      H &lt;-<span class="st"> </span><span class="kw">carroll</span>(initial_dat[<span class="dv">1</span><span class="op">:</span>(<span class="kw">NROW</span>(initial_dat)<span class="op">-</span><span class="dv">1</span>),],FLG)
      <span class="cf">if</span> (port <span class="op">==</span><span class="st"> &quot;nlgmv&quot;</span>){
        result &lt;-<span class="st"> </span><span class="kw">nlgmv</span>(initial_dat,H)
      }<span class="cf">else</span> <span class="cf">if</span> (port <span class="op">==</span><span class="st"> &quot;risk parity&quot;</span>){
        result &lt;-<span class="st"> </span><span class="kw">risk_parity</span>(initial_dat,H)
      }
      weight &lt;-<span class="st"> </span><span class="kw">t</span>(result<span class="op">$</span>weight)
      <span class="kw">colnames</span>(weight) &lt;-<span class="st"> </span><span class="kw">colnames</span>(initial_dat)
      p_return &lt;-<span class="st"> </span>initial_dat[<span class="kw">NROW</span>(initial_dat),]<span class="op">*</span>result<span class="op">$</span>weight
    } <span class="cf">else</span> {
      <span class="cf">if</span> (i <span class="op">%in%</span><span class="st"> </span><span class="kw">endpoints</span>(r_dat,span)){
        H &lt;-<span class="st"> </span><span class="kw">carroll</span>(test_dat[<span class="dv">1</span><span class="op">:</span>(<span class="kw">NROW</span>(test_dat)<span class="op">-</span><span class="dv">1</span>),],FLG)
        <span class="cf">if</span> (port <span class="op">==</span><span class="st"> &quot;nlgmv&quot;</span>){
          result &lt;-<span class="st"> </span><span class="kw">nlgmv</span>(test_dat,H)
        }<span class="cf">else</span> <span class="cf">if</span> (port <span class="op">==</span><span class="st"> &quot;risk parity&quot;</span>){
          result &lt;-<span class="st"> </span><span class="kw">risk_parity</span>(test_dat,H)
        }
        
      }
      weight &lt;-<span class="st"> </span><span class="kw">rbind</span>(weight,<span class="kw">t</span>(result<span class="op">$</span>weight))
      p_return &lt;-<span class="st"> </span><span class="kw">rbind</span>(p_return,test_dat[<span class="kw">NROW</span>(test_dat),]<span class="op">*</span>result<span class="op">$</span>weight)
    }
    <span class="cf">if</span> (i <span class="op">!=</span><span class="st"> </span><span class="kw">NROW</span>(r_dat)){
      term &lt;-<span class="st"> </span><span class="kw">stri_c</span>(<span class="kw">index</span>(r_dat[i<span class="op">+</span><span class="dv">1</span>,])<span class="op">-</span>learning_term,<span class="st">&quot;::&quot;</span>,<span class="kw">index</span>(r_dat[i<span class="op">+</span><span class="dv">1</span>,])) 
      test_dat &lt;-<span class="st"> </span>r_dat[term]
    }
  }
  p_return<span class="op">$</span>portfolio &lt;-<span class="st"> </span><span class="kw">xts</span>(<span class="kw">apply</span>(p_return,<span class="dv">1</span>,sum),<span class="dt">order.by =</span> <span class="kw">index</span>(p_return))
  weight.xts &lt;-<span class="st"> </span><span class="kw">xts</span>(weight,<span class="dt">order.by =</span> <span class="kw">index</span>(p_return))

  result &lt;-<span class="st"> </span><span class="kw">list</span>(p_return,weight.xts)
  <span class="kw">names</span>(result) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;return&quot;</span>,<span class="st">&quot;weight&quot;</span>)
  <span class="kw">return</span>(result)
}

CCC &lt;-<span class="st"> </span><span class="kw">backtest</span>(hist.returns,<span class="st">&quot;CCC&quot;</span>,<span class="st">&quot;2007-01-04&quot;</span>,<span class="st">&quot;months&quot;</span>,<span class="dv">365</span>,<span class="st">&quot;risk parity&quot;</span>)
DCC &lt;-<span class="st"> </span><span class="kw">backtest</span>(hist.returns,<span class="st">&quot;DCC&quot;</span>,<span class="st">&quot;2007-01-04&quot;</span>,<span class="st">&quot;months&quot;</span>,<span class="dv">365</span>,<span class="st">&quot;risk parity&quot;</span>)
DECO &lt;-<span class="st"> </span><span class="kw">backtest</span>(hist.returns,<span class="st">&quot;DECO&quot;</span>,<span class="st">&quot;2007-01-04&quot;</span>,<span class="st">&quot;months&quot;</span>,<span class="dv">365</span>,<span class="st">&quot;risk parity&quot;</span>)
benchmark &lt;-<span class="st"> </span><span class="kw">backtest</span>(hist.returns,<span class="st">&quot;benchmark&quot;</span>,<span class="st">&quot;2007-01-04&quot;</span>,<span class="st">&quot;months&quot;</span>,<span class="dv">365</span>,<span class="st">&quot;risk parity&quot;</span>)

result &lt;-<span class="st"> </span><span class="kw">merge</span>(CCC<span class="op">$</span>return<span class="op">$</span>portfolio,DCC<span class="op">$</span>return<span class="op">$</span>portfolio,DECO<span class="op">$</span>return<span class="op">$</span>portfolio,benchmark<span class="op">$</span>return<span class="op">$</span>portfolio)
<span class="kw">colnames</span>(result) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;CCC&quot;</span>,<span class="st">&quot;DCC&quot;</span>,<span class="st">&quot;DECO&quot;</span>,<span class="st">&quot;benchmark&quot;</span>)</code></pre>
<p>計算結果をグラフにしてみます。</p>
<pre class="sourceCode r"><code class="sourceCode r">PerformanceAnalytics<span class="op">::</span><span class="kw">charts.PerformanceSummary</span>(result,<span class="dt">main =</span> <span class="st">&quot;BACKTEST&quot;</span>)</code></pre>
<p><img src="/my_blog/post/post2_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>空売り制約を課したので、上で定義した最小分散ポートフォリオは使用していません。どうやらこれだけで解析的に解くのは難しいらしく、数値的に解くことにしています。リバランス期間を週次にしたので、自前のPCでは計算に時間がかかりましたが、結果が計算できました。</p>
<p>リーマン以降はどうやらベンチマークである等ウェイトポートフォリオよりをアウトパフォームしているようです。特に、DECOはいい感じです。そもそもDECOとDCCはほぼ変わらないパフォーマンスであると思っていたのですが、どうやら自分の理解が足らないらしく、論文の読み返す必要があるようです。Equicorrelationの意味をもう一度考えてみたいと思います。それぞれの組入比率の推移は以下のようになりました。</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># plot allocation weighting</span>
d_allocation &lt;-<span class="st"> </span><span class="cf">function</span>(ggweight,title){
  <span class="co">#install.packages(&quot;tidyverse&quot;)</span>
  <span class="kw">library</span>(tidyverse)
  ggweight &lt;-<span class="st"> </span><span class="kw">gather</span>(ggweight,<span class="dt">key=</span>ASSET,<span class="dt">value=</span>weight,<span class="op">-</span>Date,<span class="op">-</span>method)
  <span class="kw">ggplot</span>(ggweight, <span class="kw">aes</span>(<span class="dt">x=</span>Date, <span class="dt">y=</span>weight,<span class="dt">fill=</span>ASSET)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_area</span>(<span class="dt">colour=</span><span class="st">&quot;black&quot;</span>,<span class="dt">size=</span>.<span class="dv">1</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title=</span>title) <span class="op">+</span><span class="st"> </span><span class="kw">facet_grid</span>(method<span class="op">~</span>.)
}

gmv_weight &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">data.frame</span>(CCC<span class="op">$</span>weight,<span class="dt">method=</span><span class="st">&quot;CCC&quot;</span>,<span class="dt">Date=</span><span class="kw">index</span>(CCC<span class="op">$</span>weight)),<span class="kw">data.frame</span>(DCC<span class="op">$</span>weight,<span class="dt">method=</span><span class="st">&quot;DCC&quot;</span>,<span class="dt">Date=</span><span class="kw">index</span>(DCC<span class="op">$</span>weight)),<span class="kw">data.frame</span>(DECO<span class="op">$</span>weight,<span class="dt">method=</span><span class="st">&quot;DECO&quot;</span>,<span class="dt">Date=</span><span class="kw">index</span>(DECO<span class="op">$</span>weight)))

<span class="co"># plot allocation weighting</span>
<span class="kw">d_allocation</span>(gmv_weight,<span class="st">&quot;GMV Asset Allocation&quot;</span>)</code></pre>
<p><img src="/my_blog/post/post2_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p>リーマンの際にTLT、つまり米国債への比率を増やしているようです。CCCとDCCはそれ以外の部分でも米国債への比率が高く、よく挙げられる最小分散ポートフォリオの問題点がここでも発生しているようです。一方、DECOがやはり個性的な組入比率の推移をしており、ここらを考えてももう一度論文を読み返してみる必要がありそうです。</p>
<p>追記（2019/3/3）
これまでは、最小分散ポートフォリオで分析をしていましたが、リスクパリティの結果も見たいなと言うことで、そのコードも書いてみました。</p>
<pre class="sourceCode r"><code class="sourceCode r">risk_parity &lt;-<span class="st"> </span><span class="cf">function</span>(r_dat,r_cov){
  fn &lt;-<span class="st"> </span><span class="cf">function</span>(weight, r_cov) {
    N &lt;-<span class="st"> </span><span class="kw">NROW</span>(r_cov)
    risks &lt;-<span class="st">  </span>weight <span class="op">*</span><span class="st"> </span>(r_cov <span class="op">%*%</span><span class="st"> </span>weight)
    g &lt;-<span class="st"> </span><span class="kw">rep</span>(risks, <span class="dt">times =</span> N) <span class="op">-</span><span class="st"> </span><span class="kw">rep</span>(risks, <span class="dt">each =</span> N)
  <span class="kw">return</span>(<span class="kw">sum</span>(g<span class="op">^</span><span class="dv">2</span>))
  }
  dfn &lt;-<span class="st"> </span><span class="cf">function</span>(weight,r_cov){
    out &lt;-<span class="st"> </span>weight
    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">0</span><span class="op">:</span><span class="kw">length</span>(weight)) {
      up &lt;-<span class="st"> </span>dn &lt;-<span class="st"> </span>weight
      up[i] &lt;-<span class="st"> </span>up[i]<span class="op">+</span>.<span class="dv">0001</span>
      dn[i] &lt;-<span class="st"> </span>dn[i]<span class="op">-</span>.<span class="dv">0001</span>
      out[i] =<span class="st"> </span>(<span class="kw">fn</span>(up,r_cov) <span class="op">-</span><span class="st"> </span><span class="kw">fn</span>(dn,r_cov))<span class="op">/</span>.<span class="dv">0002</span>
    }
    <span class="kw">return</span>(out)
  }
  std &lt;-<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">diag</span>(r_cov)) 
  x0 &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">/</span>std<span class="op">/</span><span class="kw">sum</span>(<span class="dv">1</span><span class="op">/</span>std)
  res &lt;-<span class="st"> </span>nloptr<span class="op">::</span><span class="kw">nloptr</span>(<span class="dt">x0=</span>x0,
                 <span class="dt">eval_f=</span>fn,
                 <span class="dt">eval_grad_f=</span>dfn,
                 <span class="dt">eval_g_eq=</span><span class="cf">function</span>(weight,r_cov) { <span class="kw">sum</span>(weight) <span class="op">-</span><span class="st"> </span><span class="dv">1</span> },
                 <span class="dt">eval_jac_g_eq=</span><span class="cf">function</span>(weight,r_cov) { <span class="kw">rep</span>(<span class="dv">1</span>,<span class="kw">length</span>(std)) },
                 <span class="dt">lb=</span><span class="kw">rep</span>(<span class="dv">0</span>,<span class="kw">length</span>(std)),<span class="dt">ub=</span><span class="kw">rep</span>(<span class="dv">1</span>,<span class="kw">length</span>(std)),
                 <span class="dt">opts =</span> <span class="kw">list</span>(<span class="st">&quot;algorithm&quot;</span>=<span class="st">&quot;NLOPT_LD_SLSQP&quot;</span>,<span class="st">&quot;print_level&quot;</span> =<span class="st"> </span><span class="dv">0</span>,<span class="st">&quot;xtol_rel&quot;</span>=<span class="fl">1.0e-8</span>,<span class="st">&quot;maxeval&quot;</span> =<span class="st"> </span><span class="dv">1000</span>),
                 <span class="dt">r_cov =</span> r_cov)
  r_weight &lt;-<span class="st"> </span>res<span class="op">$</span>solution
  <span class="kw">names</span>(r_weight) &lt;-<span class="st"> </span><span class="kw">colnames</span>(r_cov)
  wr_dat &lt;-<span class="st"> </span>r_dat<span class="op">*</span>r_weight
  portfolio &lt;-<span class="st"> </span><span class="kw">apply</span>(wr_dat,<span class="dv">1</span>,sum)
  pr_dat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(wr_dat,portfolio)
  sd &lt;-<span class="st"> </span><span class="kw">sd</span>(portfolio)
  result &lt;-<span class="st"> </span><span class="kw">list</span>(r_weight,pr_dat,sd)
  <span class="kw">names</span>(result) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;weight&quot;</span>,<span class="st">&quot;return&quot;</span>,<span class="st">&quot;portfolio risk&quot;</span>)
  <span class="kw">return</span>(result)
  }

CCC &lt;-<span class="st"> </span><span class="kw">backtest</span>(hist.returns,<span class="st">&quot;CCC&quot;</span>,<span class="st">&quot;2007-01-04&quot;</span>,<span class="st">&quot;months&quot;</span>,<span class="dv">365</span>,<span class="st">&quot;risk parity&quot;</span>)
DCC &lt;-<span class="st"> </span><span class="kw">backtest</span>(hist.returns,<span class="st">&quot;DCC&quot;</span>,<span class="st">&quot;2007-01-04&quot;</span>,<span class="st">&quot;months&quot;</span>,<span class="dv">365</span>,<span class="st">&quot;risk parity&quot;</span>)
DECO &lt;-<span class="st"> </span><span class="kw">backtest</span>(hist.returns,<span class="st">&quot;DECO&quot;</span>,<span class="st">&quot;2007-01-04&quot;</span>,<span class="st">&quot;months&quot;</span>,<span class="dv">365</span>,<span class="st">&quot;risk parity&quot;</span>)
benchmark &lt;-<span class="st"> </span><span class="kw">backtest</span>(hist.returns,<span class="st">&quot;benchmark&quot;</span>,<span class="st">&quot;2007-01-04&quot;</span>,<span class="st">&quot;months&quot;</span>,<span class="dv">365</span>,<span class="st">&quot;risk parity&quot;</span>)

result &lt;-<span class="st"> </span><span class="kw">merge</span>(CCC<span class="op">$</span>return<span class="op">$</span>portfolio,DCC<span class="op">$</span>return<span class="op">$</span>portfolio,DECO<span class="op">$</span>return<span class="op">$</span>portfolio,benchmark<span class="op">$</span>return<span class="op">$</span>portfolio)
<span class="kw">colnames</span>(result) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;CCC&quot;</span>,<span class="st">&quot;DCC&quot;</span>,<span class="st">&quot;DECO&quot;</span>,<span class="st">&quot;benchmark&quot;</span>)</code></pre>
<p>結果はこんな感じ。</p>
<pre class="sourceCode r"><code class="sourceCode r">PerformanceAnalytics<span class="op">::</span><span class="kw">charts.PerformanceSummary</span>(result, <span class="dt">main =</span> <span class="st">&quot;BACKTEST COMPARISON&quot;</span>)

<span class="kw">library</span>(plotly)

<span class="co"># plot allocation weighting</span>
riskparity_weight &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">data.frame</span>(CCC<span class="op">$</span>weight,<span class="dt">method=</span><span class="st">&quot;CCC&quot;</span>,<span class="dt">Date=</span><span class="kw">index</span>(CCC<span class="op">$</span>weight)),<span class="kw">data.frame</span>(DCC<span class="op">$</span>weight,<span class="dt">method=</span><span class="st">&quot;DCC&quot;</span>,<span class="dt">Date=</span><span class="kw">index</span>(DCC<span class="op">$</span>weight)),<span class="kw">data.frame</span>(DECO<span class="op">$</span>weight,<span class="dt">method=</span><span class="st">&quot;DECO&quot;</span>,<span class="dt">Date=</span><span class="kw">index</span>(DECO<span class="op">$</span>weight)),<span class="kw">data.frame</span>(benchmark<span class="op">$</span>weight,<span class="dt">method=</span><span class="st">&quot;benchmark&quot;</span>,<span class="dt">Date=</span><span class="kw">index</span>(benchmark<span class="op">$</span>weight)))</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">PerformanceAnalytics<span class="op">::</span><span class="kw">charts.PerformanceSummary</span>(result, <span class="dt">main =</span> <span class="st">&quot;BACKTEST COMPARISON&quot;</span>)</code></pre>
<p><img src="/my_blog/post/post2_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<pre class="sourceCode r"><code class="sourceCode r">riskparity_weight &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">data.frame</span>(CCC<span class="op">$</span>weight,<span class="dt">method=</span><span class="st">&quot;CCC&quot;</span>,<span class="dt">Date=</span><span class="kw">index</span>(CCC<span class="op">$</span>weight)),<span class="kw">data.frame</span>(DCC<span class="op">$</span>weight,<span class="dt">method=</span><span class="st">&quot;DCC&quot;</span>,<span class="dt">Date=</span><span class="kw">index</span>(DCC<span class="op">$</span>weight)),<span class="kw">data.frame</span>(DECO<span class="op">$</span>weight,<span class="dt">method=</span><span class="st">&quot;DECO&quot;</span>,<span class="dt">Date=</span><span class="kw">index</span>(DECO<span class="op">$</span>weight)),<span class="kw">data.frame</span>(benchmark<span class="op">$</span>weight,<span class="dt">method=</span><span class="st">&quot;benchmark&quot;</span>,<span class="dt">Date=</span><span class="kw">index</span>(benchmark<span class="op">$</span>weight)))

<span class="co"># plot allocation weighting</span>
<span class="kw">d_allocation</span>(riskparity_weight, <span class="st">&quot;Risk Parity Asset Allocation&quot;</span>)</code></pre>
<p><img src="/my_blog/post/post2_files/figure-html/unnamed-chunk-15-2.png" width="672" /></p>
<p>どの手法もbenchmarkをアウトパーフォームできているという好ましい結果になりました。
やはり、分散共分散行列の推計がうまくいっているようです。また、DECOのパフォーマンスがよいのは、相関行列に各資産ペアの相関係数の平均値を用いているため、他の手法よりもリスク資産の組み入れが多くなったからだと思われます。ウェイトは以下の通りです。</p>
<p>とりあえず、今日はここまで。</p>
</div>

            </article>
          </div>
          
      <div class='entry-meta-bottom'>
        

  <div class="entry-categories"><p><span>Categories</span>
    
    <a href="/my_blog/categories/%E4%BB%95%E4%BA%8B%E9%96%A2%E9%80%A3" title="View all posts in 仕事関連">仕事関連</a>
  </p>
</div>



<div class="entry-tags"><p><span>Tags</span>
  

</p></div>	</div>

	
<div class="author-meta">

  <div class="author">
    	
      <img alt='Ayato Ashihara' src="https://www.gravatar.com/avatar/0334adec0ab8bf709927e209f83de319?s=100&d=identicon" class='avatar avatar-72 photo' height='72' width='72'>
    
    <span>
      Written by:<a href="https://ayatoashihara.github.io/my_blog/about/" title="Posts by Ayato Ashihara" rel="author">Ayato Ashihara</a> </span>
    </div>
    <div class="bio">
      
      
      <p></p>
      
      
	

<a class="facebook" target="_blank"
href="https://www.facebook.com/ASSIY">
<i class="fab fa-facebook-f"
title="facebook icon"></i>
</a>







<a class="linkedin" target="_blank"
href="https://www.linkedin.com/in/%E5%BD%A9%E4%BA%BA-%E8%91%A6%E5%8E%9F-9391b7143/">
<i class="fab fa-linkedin"
title="linkedin icon"></i>
</a>



<a class="email" target="_blank"
href="mailto:assiy119@yahoo.co.jp">
<i class="fas fa-envelope"
title="email icon"></i>
</a>







<a class="github" target="_blank"
href="https://github.com/AyatoAshihara/my_blog">
<i class="fab fa-github"
title="github icon"></i>
</a>







</div>
</div>

</div>
</div>

<section id="comments" class="comments">
  

  




</section>
</div>

 



    </div>

    <footer id="site-footer" class="site-footer" role="contentinfo">

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });
</script>
<script async
src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/r.min.js"></script>

<script>
  hljs.initHighlightingOnLoad();
</script>

	<h1>
    
    <a href=""> 東京の資産運用会社で働く社会人が研究に没頭するブログ </a>
    
	</h1>

			
			<p class="site-description">院卒3年目の社会人が夜な夜な更新中。本ブログの内容は筆者が所属する組織の公式見解とは全く関係ありません。</p>
			

		<div id="menu-footer" class="menu-container menu-footer" role="navigation">
		<div class="menu">

      <ul id="menu-footer-items" class="menu-footer-items">
        
</ul>

</div>	</div>

<ul class="social-media-icons">

        
				<li>
					<a class="facebook" target="_blank"
					   href="https://www.facebook.com/ASSIY" >
						<i class="fab fa-facebook-f" title="facebook"></i>
						<span class="screen-reader-text">facebook</span>
					</a>
				</li>
        

        


        

        

        
        <li>
        <a href="mailto:assiy119@yahoo.co.jp"  class="email">
            <i class="fas fa-envelope" title="email"></i>
            <span class="screen-reader-text">email</span>
        </a>
        </li>
        

        
        <li>
        <a href="https://www.linkedin.com/in/%E5%BD%A9%E4%BA%BA-%E8%91%A6%E5%8E%9F-9391b7143/" class="linkedin" target="_blank">
            <i class="fab fa-linkedin-in" title="linkedin"></i>
            <span class="screen-reader-text">linkedin</span>
        </a>
        </li>
        

        


        
        <li>
        <a href="https://github.com/AyatoAshihara/my_blog"  class="github" target="_blank">
            <i class="fab fa-github" title="github"></i>
            <span class="screen-reader-text">github</span>
        </a>
        </li>
        


        

        
        <li>
        <a href="https://ayatoashihara.github.io/my_blog/index.xml" data-animate-hover="pulse" class="rss" target="_blank">
            <i class="fas fa-rss" title="rss"></i>
            <span class="screen-reader-text">rss</span>
        </a>
        </li>
        

				</ul>	<div class="design-credit">
		
		<p>© 2018 Göran Svensson</p>
		
		<p>Nederburg Hugo Theme by <a href="https://appernetic.io">Appernetic</a>.</p>
		
		<p>A port of Tracks by Compete Themes.</p>
		
	</div>
</footer>

  </div>
  <script src="https://ayatoashihara.github.io/my_blog/js/jquery.min.js"></script>
<script src="https://ayatoashihara.github.io/my_blog/js/jquerymigrate.js"></script>
<script src="https://ayatoashihara.github.io/my_blog/js/production.min.js?v=1603208085"></script>

</body>
</html>
